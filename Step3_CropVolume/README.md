# Step 3: Crop Volume

This step is where the stitched lightsheet scans are cropped in 3D to isolate a particular volume of interest. A max projection of the stroke mask obtained from the previous step is overlayed onto a max projection of the original scan. This highlights the stroke area and allows the researcher to select their ROI with this information in mind.

# Table of Contents
* [Purpose](#purpose)
* [Usage](#usage)
* [Troubleshooting](#troulbeshooting)
* [Contact](#contact)

# Purpose
Because our scans are so large, and because the computational requirements of Aivia 9.0 do not scale well with increasing scan size, we've opted for cropping our scans to only include our ROI. We built this cropping tool in-house to minimize the number of clicks required by researchers to perform this cropping, and to integrate the stroke masks generated by the previous step to highlight the stroke region so researchers have an easier time selecting the correct ROI.  
# Usage

**Requirements:**

| Name | Version |
| ----------- | ----------- |
| Windows | 10 |
| Python | 3.6.7 |
| tiff-stack-crop-tool | 0.6 |

**Inputs:**
- `--scans_dir` : Full path to directory where scan tiff stacks are. This directory should ONLY contain scan tiff stacks.

- `--masks_dir` : Full path to directory where stroke masks are. Stroke masks should be 8-bit grayscale tiff stacks with the .tif extension. There should be one stroke mask for each scan in the scans_dir directory and this pairing should have identical ZYX dimensions. The stroke mask tiffs should be named following this example: If scans_dir has a file called scan1.tif, the corresponding stroke mask should be named scan1_stroke_mask.tif')

- `--W` : An integer value representing the width of the cropping box.

- `--H` : An integer value representing the height of the cropping box.

**Outputs:** A single tiff stack containing the cropped region for each scan supplied in the scans directory.


**Steps:**

1. This utility has been packaged with pip. Assuming you have Python 3.6.7 already installed, there is only 1 installation step:

- `pip install tiff-stack-crop-tool`

2. Before running the tool, make sure your scan and mask directories are setup as described by the **Inputs** section of this page. Run `tiff-stack-crop-tool --help` for help formatting the command to launch the tool.

3. After launching the tool, it may take a few minutes to load the first scan (our scans are ~10GB each). Once loaded, a GUI will open showing the user an XY max projection of their scan. This view allows the user to see their scan along the Z axis. Use the left and right mouse buttons to select your Z cropping region. The lines will be green if everything is OK and red if the cropping will not work. Once you're happy with your cropping lines, press space to finalize the Z cropping. Next, a Z max projection will open for the same scan. Click and drag the cropping box to select your cropping region in X and Y. Once you're happy with the placement, double-click to finalize. The tool will then perform the 3D cropping of the current scan and save it to the scan directory. The tool will then move on to the next scan in the supplied scans folder. It will continue looping like this until all scans have been cropped. **Note:** For each scan, a highlighted region will be visible in the GUI. This highlighted region shows exactly where the stroke is in this scan. It is an overlay of the stroke mask generated in the previous step of the pipeline.


# Troubleshooting

No common problems reported yet.

# Contact
* [Julian Pitney](www.julianpitney.com)
