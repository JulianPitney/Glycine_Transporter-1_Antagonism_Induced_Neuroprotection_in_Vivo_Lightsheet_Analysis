# Step 5: Aivia Analysis

This step is where the preprocessed lightsheet scans are fed into Aivia 9.0. The analysis of the scans is batched together to save time. Aivia performs a number of tasks including;

* 3D Reconstruction of the vascular network (mesh output)
* Count number of branch points in vascular network
* Estimate total length of vascular network
* Estimate vessel diameter for all vessels

These metrics are taken to be signals of overall vascular health.

# Table of Contents
* [Purpose](#purpose)
* [Usage](#usage)
* [Troubleshooting](#troulbeshooting)
* [Contact](#contact)

# Purpose
The purpose of this step is to generate high-level metrics representing different features of the vascular network. More specifically, metrics that represent features that are indicators of overall vascular health. Because it would be prohibitively time-consuming and expensive to pay researchers to generate these metrics by hand, Aivia 9.0 is used to automate the process.

# Usage

**Software Requirements:**

| Name | Version |
| ----------- | ----------- |
| Windows | 10 |
| Aivia | 9.0 |

**Hardware Requirements:** This all depends on the size of your scans, but in general you're going to want a powerful computer. Aivia's analysis is memory and compute hungry. The more you have the better. It will also make use of an Nvidia GPU for rendering the 3D reconstruction of the vascular network. Without a strong GPU it will lag so badly you won't be able to look at your scans effectively.

**Inputs:** A directory containing all the lightsheet scans that you want to analyze. These scans should be in tiff stack format. They should also be cropped to contain only your ROI because Aivia will either crash or take forever if you try to feed it scans that are too large (This was our experience even with a powerful desktop from 2019).

**Outputs:** An excel file containing all the high-level metrics generated for each scan. Aivia also allows you to export a mesh representing the 3D vascular network reconstruction if you want to.

**Steps:**

1. The first step is to prepare the directory that Aivia will read our scans from. Pick any directory on your computer and place all your cropped scans inside this folder. Ensure all your scans are in tiff stack format. Also ensure that this folder contains ONLY your scans.

2. The next step is to configure Aivia's vessel detection parameters to achieve the best possible results. First, in the `Analysis Tools` window, select the `Recipe Selection` tab. (**Note:** A recipe in Aivia is just the set of all detection parameters. They've decided to replace the word "Configuration" with "Recipe"). In the recipe selection dropdown menu, select `3D Neuron Analysis`. This recipe provides a good baseline configuration for vascular network detection. We will however need to adjust the parameters of this configuration manually to achieve the best result. The only way to do this is to load one of your scans into Aivia and experiment by adjusting the parameters and running the detection multiple times. Continue doing this until you're satisfied with the detection results on a single scan. Assuming your batch of scans all have similar properties, the settings that work for one should work well for the others. Unfortunately there's no simple algorithm for identifying the best configuration for any given set of scans. It depends entirely on the properties of the scans being analyzed. Some trial and error is required. For definitions of the individual configuration parameters, see Aivia's documentation here -> (https://drvision.atlassian.net/wiki/spaces/AW/overview). Once you've identified a configuration that works well for your current set of scans, click the `Save Recipe` button located beside the recipe selection dropdown menu. Make sure to name your recipe something descriptive. This will generate an XML file with your configuration saved inside. This XML file can be loaded by Aivia to retrieve your configuration for future use. **Note:** As with any automated data analysis, it's important to validate the automated output against manually analyzed ground truths. This should be done for every batch of scans to ensure you can trust your results.

3. Now that our scans directory and detection configuration are complete, we're ready to launch the batch analysis. Click `Tools` on Aivia's toolbar at the top of the GUI. From this dropdown, select `Batch and Cloud Processor`. This will open a new window where we'll configure our batch analysis. First, in the recipe dropdown, select the recipe that we created/saved in step 2. Then set the `Output Dir` field to point to the directory where you want all the Excel files generated by the analysis to be saved. Finally, click the `Add Local Folder` icon in the top left and add the folder where you placed all your lightsheet scans in step 1. This will populate the window on the left with all the files inside the added directory. Select all your scan files in this window and drag them into the window on the right (the window labeled `Raw Input`). We are now ready to launch our batch analysis. Click the `Create` button in the bottom right to begin. **Note:** You've probably noticed by now that this GUI is unintuitive and many of the button names don't really make sense. I agree. Please complain to Aivia and not me.

4. The runtime of the analysis will vary depending on scan size and number of scans, but in general plan to walk away for a few hours. Once the analysis has completed (as indicated by the GUI), open the directory you set as the `Output Dir` in step 3. There will be one Excel file for each analyzed scan. The Excel files will contain several pages where each page contains the data for a particular metric that's been generated. On each page, the first column will contain the `Dendrite Segment` (Named as such because the tool was originally designed for tracing neurons). Each segment is a particular segment of the vascular network (The path directly connecting two branch points). The second column contains the numerical value for whichever metric that page contains.


# Troubleshooting

No common problems reported yet.

# Contact
* [Boyang Wang](jwang149@gmail.com)
* [Julian Pitney](www.julianpitney.com)
